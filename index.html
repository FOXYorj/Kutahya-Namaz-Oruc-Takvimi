<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KÃ¼tahya Namaz Vakitleri & Asistan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #105c48;
            --primary-light: #e6f5f1;
            --accent: #d97706;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius-lg: 16px;
            --radius-md: 12px;
            --prayer-item-bg: #f8fafc;
        }

        body.dark-mode {
            --primary: #34d399;
            --primary-light: #064e3b;
            --text-dark: #f3f4f6;
            --text-gray: #9ca3af;
            --bg-body: #111827;
            --bg-card: #1f2937;
            --border-color: #374151;
            --prayer-item-bg: #111827;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); color: var(--text-dark); min-height: 100vh; padding-bottom: 40px; }
        h1, h2, h3, h4 { font-family: 'Outfit', sans-serif; color: var(--text-dark); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* Header */
        header { text-align: center; padding: 30px 0; }
        .app-title { font-size: 2.2rem; font-weight: 700; color: var(--primary); margin-bottom: 5px; }
        body.dark-mode .app-title { color: var(--text-dark); }
        .app-subtitle { color: var(--text-gray); font-size: 1rem; }

        /* Kontrol Paneli */
        .control-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card); padding: 15px 25px;
            border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);
            margin-bottom: 30px; gap: 20px; border: 1px solid var(--border-color); flex-wrap: wrap;
        }
        .district-wrapper { position: relative; min-width: 220px; flex: 1; }
        .district-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); pointer-events: none; }
        select { width: 100%; padding: 12px 20px 12px 45px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-family: inherit; color: var(--text-dark); background-color: var(--bg-body); appearance: none; outline: none; }
        .nav-buttons { display: flex; gap: 10px; background: var(--bg-body); padding: 5px; border-radius: var(--radius-md); }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--text-gray); background: transparent; }
        .btn.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow-sm); }
        .theme-toggle { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-dark); display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* Grid */
        .main-grid { display: grid; grid-template-columns: 1fr 1.4fr; gap: 30px; }
        .info-card, .tool-card { background: var(--bg-card); border-radius: var(--radius-lg); padding: 25px; box-shadow: var(--shadow-md); margin-bottom: 25px; border: 1px solid var(--border-color); }
        
        .timers-wrapper { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .next-prayer-counter { background: linear-gradient(135deg, var(--primary) 0%, #064e3b 100%); color: white; padding: 15px; border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center; }
        .ramadan-counter { background: linear-gradient(135deg, var(--accent) 0%, #b45309 100%); color: white; padding: 12px 15px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: space-between; }
        
        .prayer-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 20px; }
        .prayer-item { background: var(--prayer-item-bg); padding: 15px; border-radius: var(--radius-md); border: 1px solid transparent; }
        .prayer-item.active { background: var(--bg-card); border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light) inset; }

        /* --- AI CHAT & BÄ°LDÄ°RÄ°M STÄ°LLERÄ° --- */
        .ai-fab {
            position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px;
            border-radius: 50%; background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; cursor: pointer; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 1001;
            transition: 0.3s;
        }
        .ai-fab:hover { transform: scale(1.1); }

        .ai-chat-window {
            position: fixed; bottom: 95px; right: 25px; width: 380px; height: 550px;
            background: var(--bg-card); border-radius: 20px; display: none;
            flex-direction: column; box-shadow: var(--shadow-md); z-index: 1000;
            border: 1px solid var(--border-color); overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }
        .ai-chat-window.active { display: flex; }

        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .ai-chat-header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .ai-chat-messages { flex: 1; padding: 15px; overflow-y: auto; background: var(--prayer-item-bg); display: flex; flex-direction: column; gap: 10px; }
        .ai-msg { max-width: 80%; padding: 10px 14px; border-radius: 15px; font-size: 0.9rem; line-height: 1.4; word-wrap: break-word; }
        .ai-msg.bot { background: white; align-self: flex-start; color: #333; border-bottom-left-radius: 2px; border: 1px solid var(--border-color); }
        .ai-msg.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }

        .ai-chat-input { padding: 15px; background: var(--bg-card); border-top: 1px solid var(--border-color); display: flex; gap: 10px; }
        .ai-chat-input input { flex: 1; padding: 10px 15px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-dark); outline: none; }
        .ai-chat-input button { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .ai-menu { display: flex; gap: 5px; padding: 10px; background: var(--bg-card); overflow-x: auto; border-top: 1px solid var(--border-color); }
        .ai-menu-btn { white-space: nowrap; font-size: 0.75rem; padding: 5px 12px; border-radius: 12px; border: 1px solid var(--primary); color: var(--primary); background: transparent; cursor: pointer; font-weight: 600; }
        .ai-menu-btn:hover { background: var(--primary-light); }

        .typing { font-size: 0.75rem; color: var(--text-gray); margin-bottom: 5px; display: none; padding-left: 20px; }

        /* Calendar */
        .calendar-wrapper { background: var(--bg-card); border-radius: var(--radius-lg); padding: 25px; box-shadow: var(--shadow-md); border: 1px solid var(--border-color); margin-bottom: 25px; }
        .cal-grid-header, .cal-grid-days { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; gap: 5px; }
        .cal-grid-header span { font-size: 0.85rem; font-weight: bold; color: var(--text-gray); margin-bottom: 10px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; font-size: 0.9rem; }
        .cal-day:hover:not(.empty) { background: var(--primary-light); color: var(--primary); }
        .cal-day.today { background: var(--primary); color: white; }
        .cal-day.empty { background: transparent; cursor: default; }

        /* Tools */
        .tools-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .mini-tool-card { background: var(--bg-card); padding: 15px; border-radius: var(--radius-md); border: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; transition: transform 0.2s; box-shadow: var(--shadow-sm); }
        .mini-tool-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .tool-icon { width: 40px; height: 40px; border-radius: 50%; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 10px; }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(2px); }
        .modal-overlay.active { display: flex; }
        .modal-card { background: var(--bg-card); width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }

        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
            .ai-chat-window { width: calc(100% - 40px); height: 60vh; right: 20px; bottom: 90px; }
        }
    </style>
</head>
<body>

<div class="modal-overlay" id="generic-modal">
    <div class="modal-card">
        <div class="modal-header">
            <h3 id="modal-title">BaÅŸlÄ±k</h3>
            <button onclick="closeModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-dark)">&times;</button>
        </div>
        <div id="modal-content"></div>
    </div>
</div>

<div class="ai-fab" onclick="toggleAIChat()" title="Manevi Asistan">
    <i class="fas fa-robot"></i>
</div>

<div class="ai-chat-window" id="aiChatWindow">
    <div class="ai-chat-header">
        <span><i class="fas fa-mosque"></i> Manevi Asistan</span>
        <i class="fas fa-times" onclick="toggleAIChat()" style="cursor:pointer;"></i>
    </div>
    <div class="ai-chat-messages" id="aiMessages">
        </div>
    <div class="typing" id="aiTyping">Asistan yazÄ±yor...</div>
    <div class="ai-menu">
        <button class="ai-menu-btn" onclick="sendQuickMsg('Bana gÃ¼zel bir Cuma mesajÄ± yazar mÄ±sÄ±n?')">Cuma MesajÄ±</button>
        <button class="ai-menu-btn" onclick="sendQuickMsg('Kandil mesajÄ± hazÄ±rla.')">Kandil MesajÄ±</button>
        <button class="ai-menu-btn" onclick="sendQuickMsg('GÃ¼nÃ¼n duasÄ± nedir?')">Dua Ä°ste</button>
    </div>
    <div class="ai-chat-input">
        <input type="text" id="aiInputField" placeholder="Sorunuzu buraya yazÄ±n..." onkeypress="if(event.key === 'Enter') handleAISend()">
        <button onclick="handleAISend()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<div class="container">
    <header>
        <h1 class="app-title">KÃ¼tahya Namaz Vakitleri</h1>
        <p class="app-subtitle">Ä°badetlerinizde modern ve akÄ±llÄ± yardÄ±mcÄ±nÄ±z.</p>
    </header>

    <div class="control-bar">
        <div class="district-wrapper">
            <i class="fas fa-map-pin"></i>
            <select id="district">
                <option value="KÃ¼tahya">KÃ¼tahya Merkez</option>
                <option value="TavÅŸanlÄ±">TavÅŸanlÄ±</option>
                <option value="Simav">Simav</option>
                <option value="Gediz">Gediz</option>
                <option value="Emet">Emet</option>
                <option value="AltÄ±ntaÅŸ">AltÄ±ntaÅŸ</option>
                <option value="DomaniÃ§">DomaniÃ§</option>
                <option value="HisarcÄ±k">HisarcÄ±k</option>
                <option value="Aslanapa">Aslanapa</option>
            </select>
        </div>
        <div class="nav-buttons">
            <button class="btn active" id="btn-today" onclick="switchView('today')"><i class="fas fa-clock"></i> BugÃ¼n</button>
            <button class="btn" id="btn-calendar" onclick="switchView('calendar')"><i class="fas fa-calendar-alt"></i> Takvim</button>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon" id="theme-icon"></i></button>
    </div>

    <div class="main-grid">
        <div class="left-panel" id="today-panel">
            <div class="timers-wrapper">
                <div class="next-prayer-counter">
                    <div class="next-prayer-info">
                        <span>SÄ±radaki Vakit:</span>
                        <strong id="next-prayer-name">HesaplanÄ±yor...</strong>
                    </div>
                    <div class="next-timer" id="next-prayer-timer">--:--:--</div>
                </div>
                <div class="ramadan-counter">
                    <i class="fas fa-mosque ramadan-icon"></i>
                    <div class="ramadan-text">
                        <span>Ramazan'a Kalan</span>
                        <div class="ramadan-val" id="ramadan-countdown">HesaplanÄ±yor...</div>
                    </div>
                </div>
            </div>

            <div class="info-card">
                <div class="location-title">
                    <h2 style="display:flex; justify-content:space-between; align-items:center;">
                        <span id="display-location">KÃ¼tahya Merkez</span> 
                        <button onclick="copyTimes()" style="background:none; border:none; color:var(--text-gray); cursor:pointer;"><i class="fas fa-copy"></i></button>
                    </h2>
                    <div style="font-size: 0.9rem; color: var(--text-gray);" id="current-date-display">Tarih...</div>
                </div>
                <div class="prayer-grid" id="prayer-times-container">
                    <div style="grid-column:1/-1; text-align:center; padding:20px;">Vakitler YÃ¼kleniyor...</div>
                </div>
            </div>

            <div class="tool-card" onclick="refreshEsma()" style="cursor:pointer; border-left:4px solid var(--accent)">
                <h4 style="color:var(--accent)">GÃ¼nÃ¼n EsmÃ¢sÄ± <i class="fas fa-sync-alt fa-xs"></i></h4>
                <h2 id="esma-name" style="font-size:1.8rem;">El-Melik</h2>
                <p id="esma-meaning" style="color:var(--text-gray);">MÃ¼lkÃ¼n gerÃ§ek sahibi.</p>
            </div>
        </div>

        <div class="right-panel" id="right-panel-view">
            <div class="calendar-wrapper" id="calendar-view">
                <div class="cal-header">
                    <h3 id="cal-month-year">...</h3>
                    <div class="cal-nav">
                        <button onclick="changeMonth(-1)" style="border:none; background:none; cursor:pointer; font-size:1.2rem; color:var(--text-dark)"><i class="fas fa-chevron-left"></i></button>
                        <button onclick="changeMonth(1)" style="border:none; background:none; cursor:pointer; font-size:1.2rem; color:var(--text-dark)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="cal-grid-header"><span>Pz</span><span>Pt</span><span>Sa</span><span>Ã‡a</span><span>Pe</span><span>Cu</span><span>Ct</span></div>
                <div class="cal-grid-days" id="calendar-days-grid"></div>
            </div>

            <h3 style="margin-bottom:15px; font-size:1.1rem;">AraÃ§lar</h3>
            <div class="tools-grid">
                <div class="mini-tool-card" onclick="openZikirmatik()">
                    <div class="tool-icon"><i class="fas fa-fingerprint"></i></div>
                    <div class="tool-title">Zikirmatik</div>
                </div>
                <div class="mini-tool-card" onclick="showQiblaInfo()">
                    <div class="tool-icon"><i class="fas fa-compass"></i></div>
                    <div class="tool-title">KÄ±ble YÃ¶nÃ¼</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// --- AYARLAR ---
// API AnahtarÄ±nÄ± buraya ekledim.
const OPENROUTER_API_KEY = "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";
// Daha stabil bir model kullanÄ±yoruz.
const AI_MODEL = "google/gemini-2.0-flash-001"; 

let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let currentDistrict = "KÃ¼tahya";
let monthlyDataCache = {};
let todayTimingsObj = {};
let zikirCount = 0;

// --- BAÅžLANGIÃ‡ ---
document.addEventListener('DOMContentLoaded', () => {
    updateDateDisplay();
    refreshEsma();
    
    fetchTodayTimes();
    fetchMonthlyTimes(currentYear, currentMonth + 1);

    setTimeout(() => {
        if(document.getElementById('aiMessages').children.length === 0) {
            addMessage("Selamun AleykÃ¼m! Ben manevi asistanÄ±nÄ±z. Dini konularda yardÄ±mcÄ± olabilirim.", 'bot');
            const fab = document.querySelector('.ai-fab');
            fab.style.transform = "scale(1.2)";
            setTimeout(() => fab.style.transform = "scale(1)", 300);
        }
    }, 2000);

    setInterval(updateNextPrayerCounter, 1000);
    setInterval(updateRamadanCountdown, 1000);
    
    if(window.innerWidth <= 900) {
        document.getElementById('right-panel-view').style.display = 'none';
    }
});

// --- AI ASÄ°STAN MANTIÄžI (DÃœZELTÄ°LDÄ°) ---
async function handleAISend() {
    const input = document.getElementById('aiInputField');
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, 'user');
    input.value = "";
    
    await callOpenRouter(text);
}

function sendQuickMsg(text) {
    addMessage(text, 'user');
    callOpenRouter(text);
}

async function callOpenRouter(userText) {
    const typing = document.getElementById('aiTyping');
    typing.style.display = 'block';

    try {
        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
                "Content-Type": "application/json",
                // Ã–NEMLÄ° DÃœZELTME: Yerel dosyalar iÃ§in sahte ama geÃ§erli bir referer gÃ¶nderiyoruz.
                "HTTP-Referer": "https//knvv2.5.html", 
                "X-Title": "KÃ¼tahya Namaz Vakitleri & Asistan"
            },
            body: JSON.stringify({
                "model": AI_MODEL,
                "messages": [
                    { "role": "system", "content": "Sen yardÄ±msever bir Ä°slami asistansÄ±n. KullanÄ±cÄ±ya kÄ±sa, Ã¶z ve samimi cevaplar ver. TÄ±pkÄ± Bir Camii HocasÄ± Gibi Davan. YapÄ±mcÄ± Kim diye sorarsa Foxyorj de" },
                    { "role": "user", "content": userText }
                ]
            })
        });

        const data = await response.json();

        // Hata kontrolÃ¼
        if (!response.ok) {
            if(response.status === 401) {
                throw new Error("API AnahtarÄ± GeÃ§ersiz (401)");
            } else if (response.status === 429) {
                throw new Error("Kota Doldu (429)");
            } else {
                throw new Error(`API HatasÄ±: ${response.status}`);
            }
        }
        
        if (data.choices && data.choices.length > 0) {
            const reply = data.choices[0].message.content;
            typing.style.display = 'none';
            addMessage(reply, 'bot');
        } else {
            throw new Error("BoÅŸ cevap dÃ¶ndÃ¼");
        }

    } catch (error) {
        typing.style.display = 'none';
        console.error("AI HatasÄ±:", error);
        addMessage(`ÃœzgÃ¼nÃ¼m bir hata oluÅŸtu: ${error.message}. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.`, 'bot');
    }
}

function addMessage(text, sender) {
    const container = document.getElementById('aiMessages');
    const div = document.createElement('div');
    div.className = `ai-msg ${sender}`;
    div.innerText = text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function toggleAIChat() {
    document.getElementById('aiChatWindow').classList.toggle('active');
}

// --- NAMAZ VAKÄ°TLERÄ° ---
async function fetchTodayTimes() {
    try {
        const url = `https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(currentDistrict)}&country=Turkey&method=13`;
        const res = await fetch(url);
        const data = await res.json();
        
        if(data.code === 200) {
            todayTimingsObj = data.data.timings;
            renderPrayerCards(todayTimingsObj);
            updateNextPrayerCounter();
        }
    } catch (e) {
        console.error("Fetch HatasÄ±:", e);
        document.getElementById('prayer-times-container').innerHTML = "<div style='grid-column:1/-1; text-align:center;'>BaÄŸlantÄ± HatasÄ±</div>";
    }
}

function renderPrayerCards(timings) {
    const map = [
        { k: 'Fajr', l: 'Ä°msak', i: 'fa-cloud-moon' },
        { k: 'Sunrise', l: 'GÃ¼neÅŸ', i: 'fa-sun' },
        { k: 'Dhuhr', l: 'Ã–ÄŸle', i: 'fa-sun' },
        { k: 'Asr', l: 'Ä°kindi', i: 'fa-cloud-sun' },
        { k: 'Maghrib', l: 'AkÅŸam', i: 'fa-moon' },
        { k: 'Isha', l: 'YatsÄ±', i: 'fa-star' }
    ];
    
    const now = new Date();
    const curMin = now.getHours() * 60 + now.getMinutes();
    let activeIdx = -1;
    
    map.forEach((item, idx) => {
        const [h, m] = timings[item.k].split(':');
        if (curMin >= h * 60 + parseInt(m)) activeIdx = idx;
    });
    if (activeIdx === -1 && curMin < 300) activeIdx = 5;

    let html = '';
    map.forEach((item, idx) => {
        html += `
            <div class="prayer-item ${idx === activeIdx ? 'active' : ''}">
                <div style="font-size:0.9rem; color:var(--text-gray); margin-bottom:5px; display:flex; align-items:center; gap:8px;">
                    <i class="fas ${item.i}"></i> ${item.l}
                </div>
                <div style="font-size:1.5rem; font-weight:700">${timings[item.k]}</div>
            </div>
        `;
    });
    document.getElementById('prayer-times-container').innerHTML = html;
}

// --- TAKVÄ°M ---
async function fetchMonthlyTimes(year, month) {
    try {
        const url = `https://api.aladhan.com/v1/calendarByCity?city=${encodeURIComponent(currentDistrict)}&country=Turkey&method=13&month=${month}&year=${year}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if(data.code === 200) {
            monthlyDataCache = {};
            data.data.forEach(d => {
                const dayNum = parseInt(d.date.gregorian.day);
                monthlyDataCache[dayNum] = d;
            });
            renderCalendar(year, month);
        }
    } catch (e) { console.error(e); }
}

function renderCalendar(year, month) {
    const grid = document.getElementById('calendar-days-grid');
    const mNames = ["Ocak", "Åžubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];
    document.getElementById('cal-month-year').textContent = `${mNames[month-1]} ${year}`;
    
    const firstDay = new Date(year, month - 1, 1).getDay(); 
    const daysInMonth = new Date(year, month, 0).getDate(); 
    
    let html = '';
    for(let i = 0; i < firstDay; i++) html += `<div class="cal-day empty"></div>`;
    
    const today = new Date();
    for(let day = 1; day <= daysInMonth; day++) {
        let cls = 'cal-day';
        if(day === today.getDate() && month === (today.getMonth()+1) && year === today.getFullYear()) cls += ' today';
        html += `<div class="${cls}" onclick="openDayModal(${day})">${day}</div>`;
    }
    grid.innerHTML = html;
}

function changeMonth(delta) {
    currentMonth += delta;
    if(currentMonth < 0) { currentMonth = 11; currentYear--; }
    else if(currentMonth > 11) { currentMonth = 0; currentYear++; }
    fetchMonthlyTimes(currentYear, currentMonth + 1);
}

function openDayModal(day) {
    const data = monthlyDataCache[day];
    if(!data) return;
    const t = data.timings;
    const content = `
        <div style="text-align:center; margin-bottom:15px; font-weight:bold; color:var(--primary)">${day} ${document.getElementById('cal-month-year').textContent}</div>
        <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;"><span>Ä°msak</span> <b>${t.Fajr.split(' ')[0]}</b></div>
        <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;"><span>GÃ¼neÅŸ</span> <b>${t.Sunrise.split(' ')[0]}</b></div>
        <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;"><span>Ã–ÄŸle</span> <b>${t.Dhuhr.split(' ')[0]}</b></div>
        <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;"><span>Ä°kindi</span> <b>${t.Asr.split(' ')[0]}</b></div>
        <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;"><span>AkÅŸam</span> <b>${t.Maghrib.split(' ')[0]}</b></div>
        <div style="display:flex; justify-content:space-between; padding:8px;"><span>YatsÄ±</span> <b>${t.Isha.split(' ')[0]}</b></div>
    `;
    showModal("GÃ¼nÃ¼n Vakitleri", content);
}

// --- ARAÃ‡LAR ---
function openZikirmatik() {
    const content = `
        <div style="text-align:center; padding:20px;">
            <div id="zikir-display" style="font-size:4rem; font-weight:bold; font-family:monospace; margin-bottom:20px; color:var(--text-dark)">${zikirCount}</div>
            <button onclick="incZikir()" style="width:100px; height:100px; border-radius:50%; background:var(--primary); color:white; border:none; font-size:2rem; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.2)"><i class="fas fa-hand-pointer"></i></button>
            <br><br>
            <button onclick="resetZikir()" style="padding:8px 16px; border-radius:8px; border:1px solid var(--text-gray); background:none; color:var(--text-gray); cursor:pointer">SÄ±fÄ±rla</button>
        </div>
    `;
    showModal("Zikirmatik", content);
}
function incZikir() { zikirCount++; document.getElementById('zikir-display').innerText = zikirCount; }
function resetZikir() { zikirCount = 0; document.getElementById('zikir-display').innerText = 0; }

function showQiblaInfo() {
    const content = `
        <div style="text-align:center;">
            <div style="width:100px; height:100px; border:2px solid var(--text-gray); border-radius:50%; margin:0 auto; position:relative;">
                <div style="position:absolute; top:5px; left:50%; transform:translateX(-50%); font-size:1.2rem;">ðŸ•‹</div>
                <div style="position:absolute; top:50%; left:50%; width:4px; height:40px; background:var(--primary); transform-origin:bottom center; transform:translate(-50%, -100%) rotate(153deg);"></div>
                <div style="position:absolute; top:50%; left:50%; width:10px; height:10px; background:red; border-radius:50%; transform:translate(-50%, -50%);"></div>
            </div>
            <p style="margin-top:15px;">KÃ¼tahya iÃ§in KÄ±ble yÃ¶nÃ¼ gÃ¼neyden doÄŸuya doÄŸru yaklaÅŸÄ±k <b>153 derece</b>dir.</p>
        </div>
    `;
    showModal("KÄ±ble YÃ¶nÃ¼", content);
}

// SayaÃ§lar
function updateNextPrayerCounter() {
    if (!todayTimingsObj.Fajr) return;
    const now = new Date();
    const order = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
    const names = { Fajr:'Ä°msak', Sunrise:'GÃ¼neÅŸ', Dhuhr:'Ã–ÄŸle', Asr:'Ä°kindi', Maghrib:'AkÅŸam', Isha:'YatsÄ±' };
    
    let nextP = null, nextT = null;
    const curMin = now.getHours() * 60 + now.getMinutes();

    for (let key of order) {
        const [h, m] = todayTimingsObj[key].split(':').map(Number);
        if ((h * 60 + m) > curMin) {
            nextP = names[key];
            nextT = new Date(); nextT.setHours(h, m, 0);
            break;
        }
    }
    
    if(!nextP) {
        nextP = "YarÄ±n Ä°msak";
        const [h, m] = todayTimingsObj.Fajr.split(':').map(Number);
        nextT = new Date(); nextT.setDate(now.getDate()+1); nextT.setHours(h, m, 0);
    }
    
    const diff = nextT - now;
    const h = Math.floor(diff / 3600000);
    const m = Math.floor((diff % 3600000) / 60000);
    const s = Math.floor((diff % 60000) / 1000);
    
    document.getElementById('next-prayer-name').textContent = nextP;
    document.getElementById('next-prayer-timer').textContent = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

function updateRamadanCountdown() {
    const ramadan = new Date("2026-02-18T00:00:00");
    const diff = ramadan - new Date();
    
    if(diff <= 0) {
        document.getElementById('ramadan-countdown').textContent = "HoÅŸgeldin Ramazan!";
    } else {
        const d = Math.floor(diff / 86400000);
        document.getElementById('ramadan-countdown').textContent = `${d} GÃ¼n KaldÄ±`;
    }
}

// Genel Fonksiyonlar
function showModal(title, content) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-content').innerHTML = content;
    document.getElementById('generic-modal').classList.add('active');
}
function closeModal() { document.getElementById('generic-modal').classList.remove('active'); }
function toggleTheme() { document.body.classList.toggle('dark-mode'); }
function updateDateDisplay() {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('current-date-display').textContent = new Date().toLocaleDateString('tr-TR', options);
}
function refreshEsma() {
    const list = [{n:"Er-RahmÃ¢n", m:"DÃ¼nyada her canlÄ±ya merhamet eden."}, {n:"El-KuddÃ»s", m:"Her tÃ¼rlÃ¼ eksiklikten mÃ¼nezzeh."}, {n:"Es-SelÃ¢m", m:"KullarÄ±nÄ± selamete Ã§Ä±karan."}];
    const rnd = list[Math.floor(Math.random() * list.length)];
    document.getElementById('esma-name').innerText = rnd.n;
    document.getElementById('esma-meaning').innerText = rnd.m;
}
function copyTimes() {
    if(!todayTimingsObj.Fajr) return;
    const t = todayTimingsObj;
    const txt = `ðŸ“… ${document.getElementById('current-date-display').textContent}\nðŸ“ ${currentDistrict}\n\nÄ°msak: ${t.Fajr}\nGÃ¼neÅŸ: ${t.Sunrise}\nÃ–ÄŸle: ${t.Dhuhr}\nÄ°kindi: ${t.Asr}\nAkÅŸam: ${t.Maghrib}\nYatsÄ±: ${t.Isha}`;
    navigator.clipboard.writeText(txt).then(() => alert("Vakitler kopyalandÄ±!"));
}
function switchView(view) {
    document.getElementById('btn-today').classList.toggle('active', view === 'today');
    document.getElementById('btn-calendar').classList.toggle('active', view === 'calendar');
    
    if(window.innerWidth <= 900) {
        document.getElementById('today-panel').style.display = view === 'today' ? 'block' : 'none';
        document.getElementById('right-panel-view').style.display = view === 'calendar' ? 'block' : 'none';
    }
}
document.getElementById('district').addEventListener('change', function() {
    currentDistrict = this.value;
    document.getElementById('display-location').textContent = this.options[this.selectedIndex].text;
    fetchTodayTimes();
    fetchMonthlyTimes(currentYear, currentMonth + 1);
});
</script>
</body>
</html>
